#!/usr/bin/env python3
"""
Aegis Updates - GTK4/Libadwaita System Update Manager
A friendly GUI for pacman and yay with Catppuccin theming.
"""

import gi

gi.require_version('Gtk', '4.0')
gi.require_version('Adw', '1')
from gi.repository import Gtk, Adw, GLib, Gio
import subprocess
import threading
import os
from dataclasses import dataclass

from enum import Enum

from aegis_gtk import COLORS, setup_css

# App-specific CSS (extends base theme)
APP_CSS = f"""
.update-card {{
    background-color: {COLORS['mantle']};
    border-radius: 16px;
    padding: 20px;
    border: 2px solid {COLORS['surface0']};
}}
.update-header {{
    margin-bottom: 12px;
}}
.update-title {{
    font-weight: bold;
    color: {COLORS['text']};
}}
.update-count {{
    background-color: {COLORS['mauve']};
    color: {COLORS['crust']};
    border-radius: 12px;
    padding: 4px 12px;
    font-weight: bold;
    font-size: 12px;
}}
.package-row {{
    background-color: {COLORS['base']};
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 4px;
    border: 1px solid {COLORS['surface0']};
}}
.package-row:hover {{
    border-color: {COLORS['surface1']};
}}
.package-name {{
    font-weight: bold;
    color: {COLORS['text']};
}}
.package-version {{
    font-size: 11px;
    color: {COLORS['overlay0']};
    font-family: monospace;
}}
.package-size {{
    font-size: 11px;
    color: {COLORS['subtext0']};
}}
.package-type-official {{
    background-color: {COLORS['blue']}40;
    color: {COLORS['blue']};
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
}}
.package-type-aur {{
    background-color: {COLORS['peach']}40;
    color: {COLORS['peach']};
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
}}
.update-button {{
    background-color: {COLORS['green']};
    color: {COLORS['crust']};
    border-radius: 12px;
    padding: 14px 28px;
    font-weight: bold;
    font-size: 15px;
}}
.update-button:hover {{
    background-color: {COLORS['teal']};
}}
.update-button:disabled {{
    background-color: {COLORS['surface1']};
    color: {COLORS['overlay0']};
}}
.refresh-button {{
    background-color: {COLORS['surface0']};
    color: {COLORS['text']};
    border-radius: 8px;
    padding: 8px 16px;
}}
.refresh-button:hover {{
    background-color: {COLORS['surface1']};
}}
.terminal-output {{
    background-color: {COLORS['crust']};
    border-radius: 12px;
    padding: 16px;
    font-family: monospace;
    font-size: 12px;
    color: {COLORS['text']};
}}
.progress-bar {{
    background-color: {COLORS['surface0']};
    border-radius: 8px;
}}
.progress-bar progress {{
    background-color: {COLORS['green']};
    border-radius: 8px;
}}
.tab-bar {{
    background-color: {COLORS['mantle']};
    border-radius: 12px;
    padding: 4px;
}}
.tab-button {{
    background-color: transparent;
    color: {COLORS['overlay0']};
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: bold;
}}
.tab-button:hover {{
    background-color: {COLORS['surface0']};
}}
.tab-button.active {{
    background-color: {COLORS['mauve']};
    color: {COLORS['crust']};
}}
"""


class UpdateState(Enum):
    CHECKING = 'checking'
    UP_TO_DATE = 'up_to_date'
    UPDATES_AVAILABLE = 'updates_available'
    UPDATING = 'updating'
    ERROR = 'error'


@dataclass
class Package:
    name: str
    current_version: str
    new_version: str
    size: str
    source: str  # 'official' or 'aur'
    description: str = ''


class UpdatesWindow(Adw.ApplicationWindow):
    """Main updates window."""

    def __init__(self, app):
        super().__init__(application=app)
        self.set_title('Aegis Updates')
        self.set_default_size(700, 600)

        self.state = UpdateState.CHECKING
        self.packages: list[Package] = []
        self.update_process = None

        self._setup_css()
        self._build_ui()

        # Start checking for updates
        GLib.timeout_add(500, self._check_updates)

    def _setup_css(self):
        setup_css(self, APP_CSS)

    def _build_ui(self):
        # Main container
        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.set_content(main_box)

        # Header bar
        header = Adw.HeaderBar()
        header.add_css_class('header-bar')

        # Refresh button
        refresh_btn = Gtk.Button(icon_name='view-refresh-symbolic')
        refresh_btn.set_tooltip_text('Check for updates')
        refresh_btn.connect('clicked', self._on_refresh)
        header.pack_end(refresh_btn)

        # Settings button
        settings_btn = Gtk.Button(icon_name='emblem-system-symbolic')
        settings_btn.set_tooltip_text('Update settings')
        settings_btn.connect('clicked', self._on_settings)
        header.pack_end(settings_btn)

        main_box.append(header)

        # Content area
        self.content_stack = Gtk.Stack()
        self.content_stack.set_transition_type(Gtk.StackTransitionType.CROSSFADE)
        self.content_stack.set_vexpand(True)
        main_box.append(self.content_stack)

        # Build pages
        self._build_checking_page()
        self._build_up_to_date_page()
        self._build_updates_page()
        self._build_updating_page()
        self._build_error_page()

        self.content_stack.set_visible_child_name('checking')

    def _build_checking_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.set_valign(Gtk.Align.CENTER)
        page.set_halign(Gtk.Align.CENTER)

        spinner = Gtk.Spinner()
        spinner.set_size_request(64, 64)
        spinner.start()
        page.append(spinner)

        label = Gtk.Label(label='Checking for updates...')
        label.add_css_class('status-title')
        page.append(label)

        sublabel = Gtk.Label(label='This may take a moment')
        sublabel.add_css_class('status-subtitle')
        page.append(sublabel)

        self.content_stack.add_named(page, 'checking')

    def _build_up_to_date_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.set_valign(Gtk.Align.CENTER)
        page.set_halign(Gtk.Align.CENTER)
        page.set_margin_start(48)
        page.set_margin_end(48)

        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        card.add_css_class('status-card')
        card.set_halign(Gtk.Align.CENTER)
        page.append(card)

        icon = Gtk.Label()
        icon.set_markup(f'<span size="72000" foreground="{COLORS["green"]}">✓</span>')
        card.append(icon)

        title = Gtk.Label(label='System is up to date')
        title.add_css_class('status-title')
        card.append(title)

        subtitle = Gtk.Label(label='All packages are at their latest versions')
        subtitle.add_css_class('status-subtitle')
        card.append(subtitle)

        self.last_check_label = Gtk.Label(label='Last checked: just now')
        self.last_check_label.add_css_class('status-subtitle')
        self.last_check_label.set_margin_top(8)
        card.append(self.last_check_label)

        self.content_stack.add_named(page, 'up_to_date')

    def _build_updates_page(self):
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)

        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.add_css_class('main-container')
        scroll.set_child(page)

        # Header with count
        header = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        page.append(header)

        title = Gtk.Label(label='Updates Available')
        title.add_css_class('status-title')
        title.set_halign(Gtk.Align.START)
        header.append(title)

        self.update_count_badge = Gtk.Label(label='0')
        self.update_count_badge.add_css_class('update-count')
        header.append(self.update_count_badge)

        # Update button (top)
        self.update_btn_top = Gtk.Button(label='Update All')
        self.update_btn_top.add_css_class('update-button')
        self.update_btn_top.connect('clicked', self._on_update_all)
        self.update_btn_top.set_halign(Gtk.Align.END)
        self.update_btn_top.set_hexpand(True)
        header.append(self.update_btn_top)

        # Info banner
        info_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        info_box.add_css_class('info-banner')
        page.append(info_box)

        info_icon = Gtk.Label(label='ℹ️')
        info_box.append(info_icon)

        self.info_label = Gtk.Label(label='Review the packages below, then click Update All to install.')
        self.info_label.set_wrap(True)
        self.info_label.set_hexpand(True)
        info_box.append(self.info_label)

        # Official packages section
        self.official_card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        self.official_card.add_css_class('update-card')
        page.append(self.official_card)

        official_header = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        official_header.add_css_class('update-header')
        self.official_card.append(official_header)

        official_title = Gtk.Label(label='Official Repositories')
        official_title.add_css_class('update-title')
        official_title.set_halign(Gtk.Align.START)
        official_title.set_hexpand(True)
        official_header.append(official_title)

        self.official_count = Gtk.Label(label='0 packages')
        self.official_count.add_css_class('package-size')
        official_header.append(self.official_count)

        self.official_list = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.official_card.append(self.official_list)

        # AUR packages section
        self.aur_card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        self.aur_card.add_css_class('update-card')
        page.append(self.aur_card)

        aur_header = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        aur_header.add_css_class('update-header')
        self.aur_card.append(aur_header)

        aur_title = Gtk.Label(label='AUR Packages')
        aur_title.add_css_class('update-title')
        aur_title.set_halign(Gtk.Align.START)
        aur_title.set_hexpand(True)
        aur_header.append(aur_title)

        self.aur_count = Gtk.Label(label='0 packages')
        self.aur_count.add_css_class('package-size')
        aur_header.append(self.aur_count)

        self.aur_list = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.aur_card.append(self.aur_list)

        self.content_stack.add_named(scroll, 'updates')

    def _build_updating_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=24)
        page.set_margin_start(48)
        page.set_margin_end(48)
        page.set_margin_top(24)
        page.set_margin_bottom(24)

        # Header
        header = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        page.append(header)

        spinner = Gtk.Spinner()
        spinner.set_size_request(24, 24)
        spinner.start()
        header.append(spinner)

        self.updating_label = Gtk.Label(label='Updating system...')
        self.updating_label.add_css_class('status-title')
        header.append(self.updating_label)

        # Progress bar
        self.progress_bar = Gtk.ProgressBar()
        self.progress_bar.add_css_class('progress-bar')
        page.append(self.progress_bar)

        # Terminal output
        terminal_scroll = Gtk.ScrolledWindow()
        terminal_scroll.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.AUTOMATIC)
        terminal_scroll.set_vexpand(True)
        page.append(terminal_scroll)

        self.terminal_output = Gtk.TextView()
        self.terminal_output.set_editable(False)
        self.terminal_output.set_cursor_visible(False)
        self.terminal_output.add_css_class('terminal-output')
        self.terminal_output.set_wrap_mode(Gtk.WrapMode.WORD_CHAR)
        terminal_scroll.set_child(self.terminal_output)

        self.content_stack.add_named(page, 'updating')

    def _build_error_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.set_valign(Gtk.Align.CENTER)
        page.set_halign(Gtk.Align.CENTER)
        page.set_margin_start(48)
        page.set_margin_end(48)

        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        card.add_css_class('status-card')
        card.set_halign(Gtk.Align.CENTER)
        page.append(card)

        icon = Gtk.Label()
        icon.set_markup(f'<span size="72000" foreground="{COLORS["red"]}">⚠️</span>')
        card.append(icon)

        title = Gtk.Label(label='Update Check Failed')
        title.add_css_class('status-title')
        card.append(title)

        self.error_label = Gtk.Label(label='Could not check for updates. Please check your internet connection.')
        self.error_label.add_css_class('status-subtitle')
        self.error_label.set_wrap(True)
        self.error_label.set_max_width_chars(50)
        card.append(self.error_label)

        retry_btn = Gtk.Button(label='Retry')
        retry_btn.add_css_class('refresh-button')
        retry_btn.connect('clicked', self._on_refresh)
        retry_btn.set_halign(Gtk.Align.CENTER)
        retry_btn.set_margin_top(8)
        card.append(retry_btn)

        self.content_stack.add_named(page, 'error')

    def _check_updates(self):
        """Check for available updates in background."""
        self.state = UpdateState.CHECKING
        self.content_stack.set_visible_child_name('checking')

        thread = threading.Thread(target=self._do_check_updates)
        thread.daemon = True
        thread.start()

        return False  # Don't repeat

    def _do_check_updates(self):
        """Background thread to check for updates."""
        self.packages.clear()

        try:
            # Check official packages with checkupdates
            result = subprocess.run(['checkupdates'], capture_output=True, text=True, timeout=60)

            if result.returncode == 0 and result.stdout.strip():
                for line in result.stdout.strip().split('\n'):
                    parts = line.split()
                    if len(parts) >= 4:
                        name = parts[0]
                        current = parts[1]
                        new = parts[3]
                        self.packages.append(
                            Package(name=name, current_version=current, new_version=new, size='', source='official')
                        )

            # Check AUR packages if yay is available
            if os.path.exists('/usr/bin/yay'):
                aur_result = subprocess.run(['yay', '-Qua'], capture_output=True, text=True, timeout=60)

                if aur_result.returncode == 0 and aur_result.stdout.strip():
                    for line in aur_result.stdout.strip().split('\n'):
                        parts = line.split()
                        if len(parts) >= 4:
                            name = parts[0]
                            current = parts[1]
                            new = parts[3]
                            self.packages.append(
                                Package(name=name, current_version=current, new_version=new, size='', source='aur')
                            )

            GLib.idle_add(self._update_ui_after_check)

        except subprocess.TimeoutExpired:
            GLib.idle_add(self._show_error, 'Update check timed out. Please try again.')
        except Exception as e:
            GLib.idle_add(self._show_error, str(e))

    def _update_ui_after_check(self):
        """Update UI after checking for updates."""
        if not self.packages:
            self.state = UpdateState.UP_TO_DATE
            self.content_stack.set_visible_child_name('up_to_date')
        else:
            self.state = UpdateState.UPDATES_AVAILABLE
            self._populate_packages_list()
            self.content_stack.set_visible_child_name('updates')

    def _populate_packages_list(self):
        """Populate the packages lists."""
        # Clear existing
        for container in [self.official_list, self.aur_list]:
            while True:
                child = container.get_first_child()
                if child is None:
                    break
                container.remove(child)

        official = [p for p in self.packages if p.source == 'official']
        aur = [p for p in self.packages if p.source == 'aur']

        # Update counts
        total = len(self.packages)
        self.update_count_badge.set_label(str(total))
        self.official_count.set_label(f'{len(official)} packages')
        self.aur_count.set_label(f'{len(aur)} packages')

        # Hide sections if empty
        self.official_card.set_visible(len(official) > 0)
        self.aur_card.set_visible(len(aur) > 0)

        # Add official packages
        for pkg in official:
            row = self._create_package_row(pkg)
            self.official_list.append(row)

        # Add AUR packages
        for pkg in aur:
            row = self._create_package_row(pkg)
            self.aur_list.append(row)

    def _create_package_row(self, pkg: Package) -> Gtk.Widget:
        row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        row.add_css_class('package-row')

        info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
        info_box.set_hexpand(True)
        row.append(info_box)

        # Package name with type badge
        name_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        info_box.append(name_box)

        name_label = Gtk.Label(label=pkg.name)
        name_label.add_css_class('package-name')
        name_label.set_halign(Gtk.Align.START)
        name_box.append(name_label)

        type_badge = Gtk.Label(label=pkg.source.upper())
        type_badge.add_css_class(f'package-type-{pkg.source}')
        name_box.append(type_badge)

        # Version info
        version_label = Gtk.Label()
        version_label.set_markup(
            f'<span foreground="{COLORS["overlay0"]}">{pkg.current_version}</span> → '
            f'<span foreground="{COLORS["green"]}">{pkg.new_version}</span>'
        )
        version_label.add_css_class('package-version')
        version_label.set_halign(Gtk.Align.START)
        info_box.append(version_label)

        return row

    def _show_error(self, message: str):
        self.state = UpdateState.ERROR
        self.error_label.set_text(message)
        self.content_stack.set_visible_child_name('error')

    def _on_refresh(self, button=None):
        self._check_updates()

    def _on_settings(self, button):
        """Show update settings dialog."""
        dialog = Adw.MessageDialog(
            transient_for=self, heading='Update Settings', body='Configure automatic updates and mirror settings.'
        )

        dialog.add_response('cancel', 'Cancel')
        dialog.add_response('ok', 'OK')
        dialog.present()

    def _on_update_all(self, button):
        """Start updating all packages."""
        self.state = UpdateState.UPDATING
        self.content_stack.set_visible_child_name('updating')

        # Clear terminal
        buffer = self.terminal_output.get_buffer()
        buffer.set_text('')

        # Start update process
        thread = threading.Thread(target=self._do_update)
        thread.daemon = True
        thread.start()

    def _do_update(self):
        """Background thread to perform updates."""
        try:
            # Use pkexec for privilege escalation
            has_aur = any(p.source == 'aur' for p in self.packages)

            if has_aur and os.path.exists('/usr/bin/yay'):
                # Use yay for everything (handles both official and AUR)
                cmd = ['yay', '-Syu', '--noconfirm']
            else:
                # Use pacman for official only
                cmd = ['pkexec', 'pacman', '-Syu', '--noconfirm']

            process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, bufsize=1)

            for line in process.stdout:
                GLib.idle_add(self._append_output, line)

            process.wait()

            if process.returncode == 0:
                GLib.idle_add(self._update_complete)
            else:
                GLib.idle_add(self._update_failed)

        except Exception as e:
            GLib.idle_add(self._append_output, f'Error: {str(e)}\n')
            GLib.idle_add(self._update_failed)

    def _append_output(self, text: str):
        """Append text to terminal output."""
        buffer = self.terminal_output.get_buffer()
        end_iter = buffer.get_end_iter()
        buffer.insert(end_iter, text)

        # Scroll to bottom
        mark = buffer.create_mark(None, buffer.get_end_iter(), False)
        self.terminal_output.scroll_to_mark(mark, 0, False, 0, 0)

    def _update_complete(self):
        """Called when update completes successfully."""
        self.updating_label.set_text('Update Complete!')
        self._append_output('\n✓ All packages updated successfully!\n')
        self.progress_bar.set_fraction(1.0)

        # Show success dialog
        dialog = Adw.MessageDialog(
            transient_for=self, heading='Update Complete', body='All packages have been updated successfully.'
        )
        dialog.add_response('ok', 'OK')
        dialog.connect('response', lambda d, r: self._check_updates())
        dialog.present()

    def _update_failed(self):
        """Called when update fails."""
        self.updating_label.set_text('Update Failed')
        self._append_output('\n✗ Update failed. See output above for details.\n')


class UpdatesApp(Adw.Application):
    def __init__(self):
        super().__init__(application_id='com.aegis.updates', flags=Gio.ApplicationFlags.FLAGS_NONE)

    def do_activate(self):
        win = UpdatesWindow(self)
        win.present()


def main():
    app = UpdatesApp()
    app.run()


if __name__ == '__main__':
    main()
