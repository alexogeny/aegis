#!/usr/bin/env bash
# Aegis Linux - Developer Environment Setup
# Interactive setup for development tools and configurations

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${CYAN}[STEP]${NC} $1"; }

header() {
    echo ""
    echo -e "${BOLD}${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${BLUE}                    $1${NC}"
    echo -e "${BOLD}${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
}

# Check if command exists
has_cmd() {
    command -v "$1" &>/dev/null
}

# Prompt for yes/no
confirm() {
    local prompt="${1:-Continue?}"
    local default="${2:-y}"

    if [[ "$default" == "y" ]]; then
        prompt="$prompt [Y/n] "
    else
        prompt="$prompt [y/N] "
    fi

    read -rp "$prompt" response
    response=${response:-$default}
    [[ "$response" =~ ^[Yy] ]]
}

# ============================================================================
# Git Configuration
# ============================================================================
setup_git() {
    header "Git Configuration"

    if git config --global user.name &>/dev/null && git config --global user.email &>/dev/null; then
        log_info "Git already configured:"
        echo "  Name:  $(git config --global user.name)"
        echo "  Email: $(git config --global user.email)"
        if ! confirm "Reconfigure?"; then
            return 0
        fi
    fi

    read -rp "Enter your full name: " git_name
    read -rp "Enter your email: " git_email

    git config --global user.name "$git_name"
    git config --global user.email "$git_email"

    log_success "Git configured with: $git_name <$git_email>"

    # GPG signing
    if has_cmd gpg && confirm "Set up GPG commit signing?" "n"; then
        echo ""
        log_info "Available GPG keys:"
        gpg --list-secret-keys --keyid-format=long 2>/dev/null || log_warn "No GPG keys found"
        echo ""
        read -rp "Enter GPG key ID (or leave empty to skip): " gpg_key
        if [[ -n "$gpg_key" ]]; then
            git config --global user.signingkey "$gpg_key"
            git config --global commit.gpgsign true
            log_success "GPG signing enabled with key: $gpg_key"
        fi
    fi
}

# ============================================================================
# GitHub CLI
# ============================================================================
setup_github() {
    header "GitHub CLI (gh)"

    if ! has_cmd gh; then
        log_error "GitHub CLI not installed"
        return 1
    fi

    if gh auth status &>/dev/null; then
        log_success "Already authenticated with GitHub"
        gh auth status
        if ! confirm "Re-authenticate?" "n"; then
            return 0
        fi
    fi

    log_step "Authenticating with GitHub..."
    gh auth login

    log_success "GitHub CLI configured"

    # Set up GitHub CLI extensions
    if confirm "Install useful gh extensions?" "y"; then
        log_step "Installing gh extensions..."

        # gh dash - dashboard
        gh extension install dlvhdr/gh-dash 2>/dev/null && log_success "Installed gh-dash" || log_warn "gh-dash already installed or failed"

        # gh copilot (if available)
        gh extension install github/gh-copilot 2>/dev/null && log_success "Installed gh-copilot" || log_warn "gh-copilot not available"

        # gh poi - cleanup merged branches
        gh extension install seachicken/gh-poi 2>/dev/null && log_success "Installed gh-poi" || log_warn "gh-poi already installed or failed"
    fi
}

# ============================================================================
# GitLab CLI
# ============================================================================
setup_gitlab() {
    header "GitLab CLI (glab)"

    if ! has_cmd glab; then
        log_error "GitLab CLI not installed"
        return 1
    fi

    if glab auth status &>/dev/null; then
        log_success "Already authenticated with GitLab"
        glab auth status
        if ! confirm "Re-authenticate?" "n"; then
            return 0
        fi
    fi

    log_step "Authenticating with GitLab..."
    glab auth login

    log_success "GitLab CLI configured"
}

# ============================================================================
# SSH Keys
# ============================================================================
setup_ssh() {
    header "SSH Key Setup"

    local ssh_dir="$HOME/.ssh"
    local key_file="$ssh_dir/id_ed25519"

    mkdir -p "$ssh_dir"
    chmod 700 "$ssh_dir"

    if [[ -f "$key_file" ]]; then
        log_info "SSH key already exists: $key_file"
        echo "  Fingerprint: $(ssh-keygen -lf "$key_file.pub" 2>/dev/null || echo 'unknown')"
        if ! confirm "Generate a new key?" "n"; then
            return 0
        fi
        key_file="$ssh_dir/id_ed25519_$(date +%Y%m%d)"
    fi

    local email
    email=$(git config --global user.email 2>/dev/null || echo "")
    read -rp "Email for SSH key [$email]: " ssh_email
    ssh_email=${ssh_email:-$email}

    log_step "Generating ED25519 SSH key..."
    ssh-keygen -t ed25519 -C "$ssh_email" -f "$key_file"

    log_success "SSH key generated: $key_file"
    echo ""
    echo -e "${CYAN}Public key:${NC}"
    cat "${key_file}.pub"
    echo ""

    # Add to ssh-agent
    if confirm "Add key to ssh-agent?" "y"; then
        eval "$(ssh-agent -s)" &>/dev/null
        ssh-add "$key_file"
        log_success "Key added to ssh-agent"
    fi

    # Copy to clipboard
    if has_cmd wl-copy; then
        if confirm "Copy public key to clipboard?" "y"; then
            wl-copy < "${key_file}.pub"
            log_success "Public key copied to clipboard"
            echo ""
            echo "Add this key to:"
            echo "  GitHub:  https://github.com/settings/ssh/new"
            echo "  GitLab:  https://gitlab.com/-/profile/keys"
        fi
    fi
}

# ============================================================================
# Docker
# ============================================================================
setup_docker() {
    header "Docker Setup"

    if ! has_cmd docker; then
        log_error "Docker not installed"
        return 1
    fi

    # Check if user is in docker group
    if groups | grep -q docker; then
        log_success "User already in docker group"
    else
        log_step "Adding user to docker group..."
        sudo usermod -aG docker "$USER"
        log_success "Added to docker group (log out and back in to apply)"
    fi

    # Enable docker service
    if systemctl is-enabled docker &>/dev/null; then
        log_success "Docker service already enabled"
    else
        if confirm "Enable Docker service?" "y"; then
            sudo systemctl enable --now docker
            log_success "Docker service enabled and started"
        fi
    fi

    # Docker buildx
    if docker buildx version &>/dev/null; then
        log_success "Docker Buildx available"
    fi
}

# ============================================================================
# Language Toolchains
# ============================================================================
setup_languages() {
    header "Language Toolchains"

    # Rust
    if has_cmd rustc; then
        log_success "Rust $(rustc --version | cut -d' ' -f2)"

        if confirm "Install common Rust tools (cargo-watch, cargo-edit)?" "y"; then
            cargo install cargo-watch cargo-edit cargo-outdated 2>/dev/null || true
            log_success "Rust tools installed"
        fi
    fi

    # Node/Bun
    if has_cmd bun; then
        log_success "Bun $(bun --version)"
    fi

    # Python/uv
    if has_cmd uv; then
        log_success "uv $(uv --version | cut -d' ' -f2)"
    fi

    # Go
    if has_cmd go; then
        log_success "Go $(go version | cut -d' ' -f3)"

        if confirm "Install common Go tools?" "y"; then
            go install github.com/go-delve/delve/cmd/dlv@latest 2>/dev/null || true
            go install golang.org/x/tools/gopls@latest 2>/dev/null || true
            log_success "Go tools installed"
        fi
    fi
}

# ============================================================================
# Kubernetes
# ============================================================================
setup_kubernetes() {
    header "Kubernetes Tools"

    if has_cmd kubectl; then
        log_success "kubectl available"

        # kubectl completion
        if [[ -d "$HOME/.config/fish/completions" ]]; then
            kubectl completion fish > "$HOME/.config/fish/completions/kubectl.fish" 2>/dev/null
            log_success "kubectl completions installed for fish"
        fi
    fi

    if has_cmd k9s; then
        log_success "k9s available"
    fi

    if has_cmd helm; then
        log_success "Helm $(helm version --short 2>/dev/null | cut -d'+' -f1)"
    fi
}

# ============================================================================
# mkcert (local HTTPS)
# ============================================================================
setup_mkcert() {
    header "Local HTTPS (mkcert)"

    if ! has_cmd mkcert; then
        log_error "mkcert not installed"
        return 1
    fi

    if [[ -d "$HOME/.local/share/mkcert" ]]; then
        log_success "mkcert CA already installed"
    else
        if confirm "Install local CA for HTTPS development?" "y"; then
            mkcert -install
            log_success "Local CA installed"
            echo ""
            echo "Usage: mkcert localhost 127.0.0.1 ::1"
        fi
    fi
}

# ============================================================================
# Shell Integration
# ============================================================================
setup_shell() {
    header "Shell Integration"

    local fish_config="$HOME/.config/fish/config.fish"

    if [[ -f "$fish_config" ]]; then
        log_info "Checking fish shell integrations..."

        # direnv
        if ! grep -q "direnv hook fish" "$fish_config" 2>/dev/null; then
            if confirm "Add direnv integration to fish?" "y"; then
                echo "" >> "$fish_config"
                echo "# direnv integration" >> "$fish_config"
                echo 'direnv hook fish | source' >> "$fish_config"
                log_success "direnv integration added"
            fi
        else
            log_success "direnv integration already present"
        fi

        # zoxide
        if ! grep -q "zoxide init fish" "$fish_config" 2>/dev/null; then
            if has_cmd zoxide && confirm "Add zoxide integration to fish?" "y"; then
                echo "" >> "$fish_config"
                echo "# zoxide (smart cd)" >> "$fish_config"
                echo 'zoxide init fish | source' >> "$fish_config"
                log_success "zoxide integration added"
            fi
        else
            log_success "zoxide integration already present"
        fi
    fi
}

# ============================================================================
# Dev Status Check
# ============================================================================
show_status() {
    header "Development Environment Status"

    echo -e "${CYAN}Git:${NC}"
    if git config --global user.name &>/dev/null; then
        echo "  ✓ $(git config --global user.name) <$(git config --global user.email)>"
        [[ "$(git config --global commit.gpgsign)" == "true" ]] && echo "  ✓ GPG signing enabled"
    else
        echo "  ✗ Not configured"
    fi
    echo ""

    echo -e "${CYAN}GitHub CLI:${NC}"
    if gh auth status &>/dev/null 2>&1; then
        echo "  ✓ Authenticated"
    else
        echo "  ✗ Not authenticated (run: gh auth login)"
    fi
    echo ""

    echo -e "${CYAN}GitLab CLI:${NC}"
    if glab auth status &>/dev/null 2>&1; then
        echo "  ✓ Authenticated"
    else
        echo "  ✗ Not authenticated (run: glab auth login)"
    fi
    echo ""

    echo -e "${CYAN}SSH Keys:${NC}"
    if [[ -f "$HOME/.ssh/id_ed25519.pub" ]]; then
        echo "  ✓ $(ssh-keygen -lf "$HOME/.ssh/id_ed25519.pub" 2>/dev/null)"
    else
        echo "  ✗ No ED25519 key found"
    fi
    echo ""

    echo -e "${CYAN}Languages:${NC}"
    has_cmd rustc && echo "  ✓ Rust $(rustc --version 2>/dev/null | cut -d' ' -f2)"
    has_cmd go && echo "  ✓ Go $(go version 2>/dev/null | cut -d' ' -f3)"
    has_cmd bun && echo "  ✓ Bun $(bun --version 2>/dev/null)"
    has_cmd python && echo "  ✓ Python $(python --version 2>/dev/null | cut -d' ' -f2)"
    has_cmd uv && echo "  ✓ uv $(uv --version 2>/dev/null | cut -d' ' -f2)"
    echo ""

    echo -e "${CYAN}Containers:${NC}"
    has_cmd docker && echo "  ✓ Docker $(docker --version 2>/dev/null | cut -d' ' -f3 | tr -d ',')"
    has_cmd podman && echo "  ✓ Podman $(podman --version 2>/dev/null | cut -d' ' -f3)"
    has_cmd kubectl && echo "  ✓ kubectl $(kubectl version --client --short 2>/dev/null | cut -d' ' -f3)"
    has_cmd k9s && echo "  ✓ k9s"
    has_cmd helm && echo "  ✓ Helm $(helm version --short 2>/dev/null | cut -d'+' -f1)"
    echo ""

    echo -e "${CYAN}Dev Tools:${NC}"
    has_cmd delta && echo "  ✓ delta (git pager)"
    has_cmd difft && echo "  ✓ difftastic (structural diffs)"
    has_cmd lazygit && echo "  ✓ lazygit (TUI)"
    has_cmd just && echo "  ✓ just (command runner)"
    has_cmd direnv && echo "  ✓ direnv"
    has_cmd mkcert && echo "  ✓ mkcert (local HTTPS)"
    has_cmd age && echo "  ✓ age (encryption)"
    has_cmd sops && echo "  ✓ sops (secrets)"
    echo ""
}

# ============================================================================
# Main
# ============================================================================
main() {
    case "${1:-}" in
        status)
            show_status
            ;;
        git)
            setup_git
            ;;
        github|gh)
            setup_github
            ;;
        gitlab|glab)
            setup_gitlab
            ;;
        ssh)
            setup_ssh
            ;;
        docker)
            setup_docker
            ;;
        languages|lang)
            setup_languages
            ;;
        kubernetes|k8s)
            setup_kubernetes
            ;;
        mkcert)
            setup_mkcert
            ;;
        shell)
            setup_shell
            ;;
        all)
            setup_git
            setup_ssh
            setup_github
            setup_gitlab
            setup_docker
            setup_languages
            setup_kubernetes
            setup_mkcert
            setup_shell
            show_status
            ;;
        help|--help|-h)
            echo "Aegis Linux - Developer Environment Setup"
            echo ""
            echo "Usage: aegis-dev-setup [command]"
            echo ""
            echo "Commands:"
            echo "  status      Show current dev environment status"
            echo "  all         Run all setup steps interactively"
            echo "  git         Configure git (name, email, GPG)"
            echo "  ssh         Generate/manage SSH keys"
            echo "  github      Authenticate GitHub CLI (gh)"
            echo "  gitlab      Authenticate GitLab CLI (glab)"
            echo "  docker      Set up Docker permissions"
            echo "  languages   Set up language toolchains"
            echo "  kubernetes  Set up Kubernetes tools"
            echo "  mkcert      Install local CA for HTTPS"
            echo "  shell       Add shell integrations"
            echo "  help        Show this help"
            echo ""
            echo "Run without arguments for interactive setup."
            ;;
        "")
            header "Aegis Developer Environment Setup"
            echo "This will help you configure your development environment."
            echo ""

            if confirm "Run full setup?" "y"; then
                setup_git
                setup_ssh
                if confirm "Set up GitHub CLI?" "y"; then setup_github; fi
                if confirm "Set up GitLab CLI?" "y"; then setup_gitlab; fi
                setup_docker
                setup_languages
                setup_kubernetes
                setup_mkcert
                setup_shell

                echo ""
                show_status
            else
                echo ""
                echo "Run 'aegis-dev-setup help' to see available commands."
            fi
            ;;
        *)
            log_error "Unknown command: $1"
            echo "Run 'aegis-dev-setup help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
