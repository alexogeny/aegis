#!/usr/bin/env bash
# Aegis Linux - First Boot Configuration Script
# =============================================================================
# This script runs on first boot to configure the system
# =============================================================================

set -euo pipefail

# Check if running in install mode (from Calamares)
INSTALL_MODE="${1:-}"

log() {
    echo "[Aegis] $1"
    logger -t aegis-first-boot "$1"
}

# Send desktop notification if possible
notify() {
    if command -v notify-send &>/dev/null && [[ -n "${DISPLAY:-}" || -n "${WAYLAND_DISPLAY:-}" ]]; then
        notify-send "Aegis Linux" "$1" --icon=security-high
    fi
}

# Configure AppArmor
configure_apparmor() {
    log "Configuring AppArmor..."

    # Ensure AppArmor is enabled
    if systemctl is-enabled apparmor.service &>/dev/null; then
        log "AppArmor service already enabled"
    else
        systemctl enable apparmor.service
    fi

    # Load firejail AppArmor profile for integration
    if [[ -f /etc/apparmor.d/firejail-default ]]; then
        log "Loading firejail AppArmor profile..."
        apparmor_parser -r /etc/apparmor.d/firejail-default 2>/dev/null || true
    fi

    # Load all profiles
    if [[ -d /etc/apparmor.d ]]; then
        log "Loading AppArmor profiles..."

        # Set profiles to complain mode initially for user-friendly experience
        # Users can transition to enforce mode when ready
        if command -v aa-complain &>/dev/null; then
            find /etc/apparmor.d -maxdepth 1 -type f -exec aa-complain {} \; 2>/dev/null || true
        fi
    fi

    log "AppArmor configured"
}

# Configure GTK4 theme for all users
configure_gtk_theme() {
    log "Configuring GTK4 theme..."

    while IFS=: read -r username _ uid _ _ home _; do
        if [[ $uid -ge 1000 && $uid -lt 65534 && -d "$home" ]]; then
            # Create GTK4 config directory
            mkdir -p "$home/.config/gtk-4.0"

            # Symlink Colloid Catppuccin theme for GTK4 apps
            local theme_dir="/usr/share/themes/Colloid-Dark-Catppuccin/gtk-4.0"
            if [[ -d "$theme_dir" ]]; then
                ln -sf "$theme_dir/assets" "$home/.config/gtk-4.0/" 2>/dev/null || true
                ln -sf "$theme_dir/gtk.css" "$home/.config/gtk-4.0/" 2>/dev/null || true
                ln -sf "$theme_dir/gtk-dark.css" "$home/.config/gtk-4.0/" 2>/dev/null || true
            fi

            chown -R "$username:$username" "$home/.config/gtk-4.0" 2>/dev/null || true
            log "Configured GTK4 theme for user: $username"
        fi
    done < /etc/passwd
}

# Check system security status
security_check() {
    log "Running security checks..."

    local issues=()

    # Check AppArmor
    if ! aa-status &>/dev/null; then
        issues+=("AppArmor not running")
    fi

    # Check firewall
    if ! systemctl is-active nftables.service &>/dev/null; then
        issues+=("Firewall not active")
    fi

    # Check audit
    if ! systemctl is-active auditd.service &>/dev/null; then
        issues+=("Audit daemon not running")
    fi

    # Check kernel lockdown
    if [[ -f /sys/kernel/security/lockdown ]]; then
        local lockdown
        lockdown=$(cat /sys/kernel/security/lockdown)
        if [[ "$lockdown" != *"confidentiality"* ]]; then
            issues+=("Kernel lockdown not in confidentiality mode")
        fi
    fi

    if [[ ${#issues[@]} -eq 0 ]]; then
        log "All security checks passed"
        notify "Security check passed. System is protected."
    else
        log "Security issues found: ${issues[*]}"
        notify "Security issues found: ${issues[*]}"
    fi
}

# Create user directories
setup_user_dirs() {
    log "Setting up user directories..."

    # Get all non-system users
    while IFS=: read -r username _ uid _ _ home _; do
        if [[ $uid -ge 1000 && $uid -lt 65534 && -d "$home" ]]; then
            # Create Screenshots directory
            mkdir -p "$home/Pictures/Screenshots"

            # Set ownership
            chown -R "$username:$username" "$home/Pictures" 2>/dev/null || true

            log "Set up directories for user: $username"
        fi
    done < /etc/passwd
}

# Configure snapper for btrfs snapshots
configure_snapper() {
    log "Configuring Snapper for btrfs snapshots..."

    # Check if root is btrfs
    if ! findmnt -n -o FSTYPE / | grep -q btrfs; then
        log "Root filesystem is not btrfs, skipping snapper configuration"
        return
    fi

    # Check if snapper is installed
    if ! command -v snapper &>/dev/null; then
        log "Snapper not installed, skipping configuration"
        return
    fi

    # Check if snapper config for root already exists
    if snapper list-configs 2>/dev/null | grep -q "^root"; then
        log "Snapper root config already exists"
    else
        # Create snapper config for root
        log "Creating snapper config for root..."

        # Ensure /.snapshots subvolume exists
        if [[ ! -d /.snapshots ]]; then
            log "Creating /.snapshots directory..."
            mkdir -p /.snapshots
        fi

        # Create the snapper config
        snapper -c root create-config / 2>/dev/null || true

        # Configure snapper settings for reasonable defaults
        if [[ -f /etc/snapper/configs/root ]]; then
            # Keep reasonable number of snapshots
            sed -i 's/^TIMELINE_LIMIT_HOURLY=.*/TIMELINE_LIMIT_HOURLY="5"/' /etc/snapper/configs/root
            sed -i 's/^TIMELINE_LIMIT_DAILY=.*/TIMELINE_LIMIT_DAILY="7"/' /etc/snapper/configs/root
            sed -i 's/^TIMELINE_LIMIT_WEEKLY=.*/TIMELINE_LIMIT_WEEKLY="4"/' /etc/snapper/configs/root
            sed -i 's/^TIMELINE_LIMIT_MONTHLY=.*/TIMELINE_LIMIT_MONTHLY="3"/' /etc/snapper/configs/root
            sed -i 's/^TIMELINE_LIMIT_YEARLY=.*/TIMELINE_LIMIT_YEARLY="0"/' /etc/snapper/configs/root

            # Enable timeline snapshots
            sed -i 's/^TIMELINE_CREATE=.*/TIMELINE_CREATE="yes"/' /etc/snapper/configs/root
        fi

        log "Snapper config created for root"
    fi

    # Enable snapper timer for automatic snapshots
    systemctl enable --now snapper-timeline.timer 2>/dev/null || true
    systemctl enable --now snapper-cleanup.timer 2>/dev/null || true

    # Enable grub-btrfsd for boot menu integration
    if systemctl list-unit-files | grep -q grub-btrfsd; then
        systemctl enable --now grub-btrfsd 2>/dev/null || true
        log "Enabled grub-btrfsd for boot menu snapshot integration"
    fi

    log "Snapper configured successfully"
}

# Main function
main() {
    log "Starting Aegis first boot configuration..."

    if [[ "$INSTALL_MODE" == "--install" ]]; then
        # Running from Calamares installer
        log "Running in install mode"
        configure_apparmor
        configure_gtk_theme
        configure_snapper
    else
        # Running on actual first boot
        log "Running on first boot"
        configure_apparmor
        configure_gtk_theme
        configure_snapper
        setup_user_dirs
        security_check
    fi

    log "First boot configuration complete"
}

# Run main function
main
