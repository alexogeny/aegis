#!/usr/bin/env python3
"""
Aegis Backup - GTK4/Libadwaita Backup and Restore
A friendly GUI for btrfs snapshots using Snapper with Catppuccin theming.
"""

import gi

gi.require_version('Gtk', '4.0')
gi.require_version('Adw', '1')
from gi.repository import Gtk, Adw, GLib, Gio
import subprocess
import threading
import json
import os
import re
from datetime import datetime
from dataclasses import dataclass
from typing import Optional, List
from pathlib import Path
from enum import Enum

from aegis_gtk import COLORS, setup_css

# App-specific CSS (extends base theme)
APP_CSS = f"""
.backup-card {{
    background-color: {COLORS['mantle']};
    border-radius: 16px;
    padding: 20px;
    border: 2px solid {COLORS['surface0']};
}}
.backup-header {{
    margin-bottom: 12px;
}}
.backup-title {{
    font-weight: bold;
    font-size: 16px;
    color: {COLORS['text']};
}}
.snapshot-row {{
    background-color: {COLORS['base']};
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 8px;
    border: 1px solid {COLORS['surface0']};
}}
.snapshot-row:hover {{
    border-color: {COLORS['surface1']};
}}
.snapshot-name {{
    font-weight: bold;
    color: {COLORS['text']};
    font-size: 14px;
}}
.snapshot-date {{
    font-size: 12px;
    color: {COLORS['overlay0']};
}}
.snapshot-type {{
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
}}
.snapshot-type-manual {{
    background-color: {COLORS['blue']}40;
    color: {COLORS['blue']};
}}
.snapshot-type-scheduled {{
    background-color: {COLORS['green']}40;
    color: {COLORS['green']};
}}
.snapshot-type-boot {{
    background-color: {COLORS['peach']}40;
    color: {COLORS['peach']};
}}
.snapshot-size {{
    font-size: 11px;
    color: {COLORS['subtext0']};
}}
.create-button {{
    background-color: {COLORS['green']};
    color: {COLORS['crust']};
    border-radius: 12px;
    padding: 14px 28px;
    font-weight: bold;
    font-size: 15px;
}}
.create-button:hover {{
    background-color: {COLORS['teal']};
}}
.restore-button {{
    background-color: {COLORS['blue']};
    color: {COLORS['crust']};
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: bold;
}}
.restore-button:hover {{
    background-color: {COLORS['sapphire']};
}}
.delete-button {{
    background-color: {COLORS['surface0']};
    color: {COLORS['text']};
    border-radius: 8px;
    padding: 8px 12px;
}}
.delete-button:hover {{
    background-color: {COLORS['red']};
    color: {COLORS['crust']};
}}
.progress-box {{
    background-color: {COLORS['mantle']};
    border-radius: 12px;
    padding: 24px;
    border: 2px solid {COLORS['surface0']};
}}
.progress-bar {{
    background-color: {COLORS['surface0']};
    border-radius: 8px;
}}
.progress-bar progress {{
    background-color: {COLORS['green']};
    border-radius: 8px;
}}
.empty-state {{
    padding: 48px;
}}
.empty-icon {{
    font-size: 64px;
    color: {COLORS['overlay0']};
}}
.empty-title {{
    font-size: 18px;
    font-weight: bold;
    color: {COLORS['text']};
}}
.empty-description {{
    color: {COLORS['subtext0']};
}}
"""


class SnapshotType(Enum):
    MANUAL = 'manual'
    SCHEDULED = 'scheduled'
    BOOT = 'boot'


@dataclass
class Snapshot:
    id: str
    name: str
    date: datetime
    snapshot_type: SnapshotType
    size: str
    description: str


class BackupWindow(Adw.ApplicationWindow):
    """Main backup window."""

    def __init__(self, app):
        super().__init__(application=app)
        self.set_title('Aegis Backup')
        self.set_default_size(900, 650)

        self.snapshots: list[Snapshot] = []
        self.current_page = 'snapshots'
        self.backup_tool = self._detect_backup_tool()

        self._setup_css()
        self._build_ui()
        self._load_snapshots()

    def _setup_css(self):
        setup_css(self, APP_CSS)

    def _detect_backup_tool(self) -> str:
        """Detect which backup tool is available. Prefer snapper for btrfs."""
        # Check if root is btrfs - if so, use snapper
        if self._is_btrfs_root() and os.path.exists('/usr/bin/snapper'):
            return 'snapper'
        elif os.path.exists('/usr/bin/snapper'):
            return 'snapper'
        return 'none'

    def _is_btrfs_root(self) -> bool:
        """Check if the root filesystem is btrfs."""
        try:
            result = subprocess.run(
                ['findmnt', '-n', '-o', 'FSTYPE', '/'],
                capture_output=True, text=True, timeout=5
            )
            return result.stdout.strip() == 'btrfs'
        except Exception:
            return False

    def _check_snapper_config(self) -> bool:
        """Check if snapper is configured for root."""
        try:
            result = subprocess.run(
                ['snapper', 'list-configs'],
                capture_output=True, text=True, timeout=10
            )
            return 'root' in result.stdout
        except Exception:
            return False

    def _build_ui(self):
        # Main container
        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.set_content(main_box)

        # Header bar
        header = Adw.HeaderBar()
        header.add_css_class('header-bar')

        # Create backup button
        create_btn = Gtk.Button(label='Create Snapshot')
        create_btn.add_css_class('create-button')
        create_btn.connect('clicked', self._on_create_snapshot)
        header.pack_end(create_btn)

        # Refresh button
        refresh_btn = Gtk.Button(icon_name='view-refresh-symbolic')
        refresh_btn.set_tooltip_text('Refresh snapshots')
        refresh_btn.connect('clicked', self._on_refresh)
        header.pack_end(refresh_btn)

        main_box.append(header)

        # Content with sidebar
        content_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=0)
        content_box.set_vexpand(True)
        main_box.append(content_box)

        # Sidebar
        sidebar = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        sidebar.add_css_class('sidebar')
        sidebar.set_size_request(180, -1)
        content_box.append(sidebar)

        # Sidebar items
        sidebar_items = [
            ('snapshots', 'üíæ', 'Snapshots'),
            ('schedule', 'üìÖ', 'Schedule'),
            ('settings', '‚öôÔ∏è', 'Settings'),
        ]

        self.sidebar_buttons = {}
        for page_id, icon, label in sidebar_items:
            btn = Gtk.Button()
            btn.add_css_class('sidebar-item')
            if page_id == 'snapshots':
                btn.add_css_class('active')

            btn_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
            btn.set_child(btn_box)

            icon_label = Gtk.Label(label=icon)
            btn_box.append(icon_label)

            text_label = Gtk.Label(label=label)
            text_label.set_halign(Gtk.Align.START)
            btn_box.append(text_label)

            btn.connect('clicked', self._on_sidebar_click, page_id)
            sidebar.append(btn)
            self.sidebar_buttons[page_id] = btn

        # Main content area
        self.content_stack = Gtk.Stack()
        self.content_stack.set_transition_type(Gtk.StackTransitionType.CROSSFADE)
        self.content_stack.set_hexpand(True)
        content_box.append(self.content_stack)

        # Build pages
        self._build_snapshots_page()
        self._build_schedule_page()
        self._build_settings_page()

    def _build_snapshots_page(self):
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)

        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.add_css_class('main-container')
        scroll.set_child(page)

        # Status card
        self.status_card = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=16)
        self.status_card.add_css_class('status-card')
        page.append(self.status_card)

        status_icon = Gtk.Label()
        status_icon.set_markup(f'<span size="48000" foreground="{COLORS["green"]}">‚úì</span>')
        self.status_card.append(status_icon)

        status_info = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
        status_info.set_hexpand(True)
        self.status_card.append(status_info)

        self.status_title = Gtk.Label(label='System Protected')
        self.status_title.add_css_class('status-title')
        self.status_title.set_halign(Gtk.Align.START)
        status_info.append(self.status_title)

        self.status_subtitle = Gtk.Label(label='Last snapshot: Never')
        self.status_subtitle.add_css_class('status-subtitle')
        self.status_subtitle.set_halign(Gtk.Align.START)
        status_info.append(self.status_subtitle)

        # Tool info
        tool_label = Gtk.Label()
        tool_text = 'Snapper (btrfs)' if self.backup_tool == 'snapper' else 'Not configured'
        tool_label.set_markup(f'<span foreground="{COLORS["overlay0"]}">Using: {tool_text}</span>')
        self.status_card.append(tool_label)

        # Info banner
        info_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        info_box.add_css_class('info-banner')
        page.append(info_box)

        info_icon = Gtk.Label(label='‚ÑπÔ∏è')
        info_box.append(info_icon)

        info_label = Gtk.Label(
            label='Snapshots let you restore your system to a previous state if something goes wrong.'
        )
        info_label.set_wrap(True)
        info_label.set_hexpand(True)
        info_box.append(info_label)

        # Snapshots list card
        snapshots_card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        snapshots_card.add_css_class('backup-card')
        page.append(snapshots_card)

        header = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        header.add_css_class('backup-header')
        snapshots_card.append(header)

        title = Gtk.Label(label='Available Snapshots')
        title.add_css_class('backup-title')
        title.set_halign(Gtk.Align.START)
        title.set_hexpand(True)
        header.append(title)

        self.snapshot_count = Gtk.Label(label='0 snapshots')
        self.snapshot_count.add_css_class('snapshot-size')
        header.append(self.snapshot_count)

        self.snapshots_list = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        snapshots_card.append(self.snapshots_list)

        # Empty state
        self.empty_state = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        self.empty_state.add_css_class('empty-state')
        self.empty_state.set_halign(Gtk.Align.CENTER)
        snapshots_card.append(self.empty_state)

        empty_icon = Gtk.Label(label='üì¶')
        empty_icon.add_css_class('empty-icon')
        self.empty_state.append(empty_icon)

        empty_title = Gtk.Label(label='No Snapshots Yet')
        empty_title.add_css_class('empty-title')
        self.empty_state.append(empty_title)

        empty_desc = Gtk.Label(label='Create your first snapshot to protect your system.')
        empty_desc.add_css_class('empty-description')
        self.empty_state.append(empty_desc)

        self.content_stack.add_named(scroll, 'snapshots')

    def _build_schedule_page(self):
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)

        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.add_css_class('main-container')
        scroll.set_child(page)

        # Title
        title = Gtk.Label(label='Automatic Snapshots')
        title.set_markup(f'<span size="x-large" weight="bold" foreground="{COLORS["text"]}">Automatic Snapshots</span>')
        title.set_halign(Gtk.Align.START)
        page.append(title)

        desc = Gtk.Label(label='Configure automatic snapshot schedule to keep your system protected.')
        desc.add_css_class('status-subtitle')
        desc.set_halign(Gtk.Align.START)
        page.append(desc)

        # Schedule settings
        schedule_card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        schedule_card.add_css_class('backup-card')
        page.append(schedule_card)

        # Boot snapshots
        boot_row = self._create_schedule_row('Boot Snapshots', 'Create a snapshot every time the system boots', True)
        schedule_card.append(boot_row)

        # Hourly snapshots
        hourly_row = self._create_schedule_row('Hourly Snapshots', 'Keep up to 5 hourly snapshots', False)
        schedule_card.append(hourly_row)

        # Daily snapshots
        daily_row = self._create_schedule_row('Daily Snapshots', 'Keep up to 7 daily snapshots', True)
        schedule_card.append(daily_row)

        # Weekly snapshots
        weekly_row = self._create_schedule_row('Weekly Snapshots', 'Keep up to 4 weekly snapshots', True)
        schedule_card.append(weekly_row)

        # Monthly snapshots
        monthly_row = self._create_schedule_row('Monthly Snapshots', 'Keep up to 3 monthly snapshots', False)
        schedule_card.append(monthly_row)

        self.content_stack.add_named(scroll, 'schedule')

    def _create_schedule_row(self, label: str, description: str, default: bool) -> Gtk.Widget:
        row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        row.add_css_class('settings-row')

        info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
        info_box.set_hexpand(True)
        row.append(info_box)

        label_widget = Gtk.Label(label=label)
        label_widget.add_css_class('settings-label')
        label_widget.set_halign(Gtk.Align.START)
        info_box.append(label_widget)

        desc_widget = Gtk.Label(label=description)
        desc_widget.add_css_class('settings-description')
        desc_widget.set_halign(Gtk.Align.START)
        info_box.append(desc_widget)

        switch = Gtk.Switch()
        switch.set_active(default)
        switch.set_valign(Gtk.Align.CENTER)
        row.append(switch)

        return row

    def _build_settings_page(self):
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)

        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        page.add_css_class('main-container')
        scroll.set_child(page)

        # Title
        title = Gtk.Label(label='Backup Settings')
        title.set_markup(f'<span size="x-large" weight="bold" foreground="{COLORS["text"]}">Backup Settings</span>')
        title.set_halign(Gtk.Align.START)
        page.append(title)

        # Settings card
        settings_card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        settings_card.add_css_class('backup-card')
        page.append(settings_card)

        # Backup location
        location_row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        location_row.add_css_class('settings-row')
        settings_card.append(location_row)

        loc_info = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
        loc_info.set_hexpand(True)
        location_row.append(loc_info)

        loc_label = Gtk.Label(label='Backup Location')
        loc_label.add_css_class('settings-label')
        loc_label.set_halign(Gtk.Align.START)
        loc_info.append(loc_label)

        loc_desc = Gtk.Label(label='Where to store system snapshots')
        loc_desc.add_css_class('settings-description')
        loc_desc.set_halign(Gtk.Align.START)
        loc_info.append(loc_desc)

        location_dropdown = Gtk.DropDown.new_from_strings(
            ['Local disk (/.snapshots)', 'External drive', 'Network location']
        )
        location_row.append(location_dropdown)

        # Include home
        home_row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        home_row.add_css_class('settings-row')
        settings_card.append(home_row)

        home_info = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
        home_info.set_hexpand(True)
        home_row.append(home_info)

        home_label = Gtk.Label(label='Include Home Directory')
        home_label.add_css_class('settings-label')
        home_label.set_halign(Gtk.Align.START)
        home_info.append(home_label)

        home_desc = Gtk.Label(label='Back up user files along with system')
        home_desc.add_css_class('settings-description')
        home_desc.set_halign(Gtk.Align.START)
        home_info.append(home_desc)

        home_switch = Gtk.Switch()
        home_switch.set_active(False)
        home_switch.set_valign(Gtk.Align.CENTER)
        home_row.append(home_switch)

        # Compression
        compression_row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        compression_row.add_css_class('settings-row')
        settings_card.append(compression_row)

        comp_info = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
        comp_info.set_hexpand(True)
        compression_row.append(comp_info)

        comp_label = Gtk.Label(label='Compression')
        comp_label.add_css_class('settings-label')
        comp_label.set_halign(Gtk.Align.START)
        comp_info.append(comp_label)

        comp_desc = Gtk.Label(label='Compress snapshots to save space')
        comp_desc.add_css_class('settings-description')
        comp_desc.set_halign(Gtk.Align.START)
        comp_info.append(comp_desc)

        comp_dropdown = Gtk.DropDown.new_from_strings(['None (fastest)', 'Fast (zstd)', 'Maximum (zstd -19)'])
        comp_dropdown.set_selected(1)
        compression_row.append(comp_dropdown)

        # Warning banner
        warning_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        warning_box.add_css_class('warning-banner')
        warning_box.set_margin_top(16)
        page.append(warning_box)

        warning_icon = Gtk.Label(label='‚ö†Ô∏è')
        warning_box.append(warning_icon)

        warning_label = Gtk.Label(
            label='System snapshots do not back up personal files. Use a separate backup solution for important data.'
        )
        warning_label.set_wrap(True)
        warning_label.set_hexpand(True)
        warning_box.append(warning_label)

        self.content_stack.add_named(scroll, 'settings')

    def _on_sidebar_click(self, button, page_id):
        for pid, btn in self.sidebar_buttons.items():
            if pid == page_id:
                btn.add_css_class('active')
            else:
                btn.remove_css_class('active')

        self.content_stack.set_visible_child_name(page_id)
        self.current_page = page_id

    def _load_snapshots(self):
        """Load snapshots from snapper."""
        self.snapshots.clear()

        try:
            if self.backup_tool == 'snapper':
                # Try JSON output first (newer snapper versions)
                result = subprocess.run(
                    ['snapper', '--jsonout', 'list'],
                    capture_output=True, text=True, timeout=30
                )

                if result.returncode == 0 and result.stdout.strip():
                    try:
                        data = json.loads(result.stdout)
                        # Handle both old and new JSON formats
                        snapshots_data = data.get('root', data.get('snapshots', []))
                        if isinstance(snapshots_data, dict):
                            snapshots_data = snapshots_data.get('snapshots', [])

                        for snap in snapshots_data:
                            if snap.get('number', 0) == 0:
                                continue  # Skip snapshot 0 (current)

                            snap_type = snap.get('type', 'single')
                            cleanup = snap.get('cleanup', '')

                            # Determine snapshot type from snapper data
                            if snap_type == 'pre':
                                s_type = SnapshotType.SCHEDULED
                            elif snap_type == 'post':
                                s_type = SnapshotType.SCHEDULED
                            elif 'timeline' in cleanup:
                                s_type = SnapshotType.SCHEDULED
                            elif 'boot' in snap.get('description', '').lower():
                                s_type = SnapshotType.BOOT
                            else:
                                s_type = SnapshotType.MANUAL

                            # Parse date
                            date_str = snap.get('date', '')
                            try:
                                if date_str:
                                    snap_date = datetime.fromisoformat(
                                        date_str.replace('Z', '+00:00').replace(' ', 'T')
                                    )
                                else:
                                    snap_date = datetime.now()
                            except ValueError:
                                snap_date = datetime.now()

                            description = snap.get('description', '')
                            name = description if description else f'Snapshot #{snap.get("number", 0)}'

                            self.snapshots.append(
                                Snapshot(
                                    id=str(snap.get('number', 0)),
                                    name=name,
                                    date=snap_date,
                                    snapshot_type=s_type,
                                    size=cleanup if cleanup else 'btrfs',
                                    description=description,
                                )
                            )
                    except json.JSONDecodeError:
                        # Fall back to text parsing
                        self._parse_snapper_text_output()
                else:
                    self._parse_snapper_text_output()

        except Exception as e:
            # Show empty state if snapper not configured
            pass

        self._populate_snapshots_list()

    def _parse_snapper_text_output(self):
        """Parse snapper list output in text format."""
        try:
            result = subprocess.run(
                ['snapper', 'list'],
                capture_output=True, text=True, timeout=30
            )

            if result.returncode == 0:
                lines = result.stdout.strip().split('\n')
                # Skip header lines
                for line in lines[2:]:
                    parts = re.split(r'\s*\|\s*', line.strip())
                    if len(parts) >= 5:
                        try:
                            snap_num = parts[0].strip()
                            if snap_num == '0' or not snap_num.isdigit():
                                continue

                            snap_type = parts[1].strip()
                            date_str = parts[3].strip()
                            description = parts[5].strip() if len(parts) > 5 else ''

                            # Parse date
                            try:
                                snap_date = datetime.strptime(date_str, '%a %b %d %H:%M:%S %Y')
                            except ValueError:
                                try:
                                    snap_date = datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S')
                                except ValueError:
                                    snap_date = datetime.now()

                            # Determine type
                            if snap_type == 'pre':
                                s_type = SnapshotType.SCHEDULED
                            elif snap_type == 'post':
                                s_type = SnapshotType.SCHEDULED
                            else:
                                s_type = SnapshotType.MANUAL

                            name = description if description else f'Snapshot #{snap_num}'

                            self.snapshots.append(
                                Snapshot(
                                    id=snap_num,
                                    name=name,
                                    date=snap_date,
                                    snapshot_type=s_type,
                                    size='btrfs',
                                    description=description,
                                )
                            )
                        except (ValueError, IndexError):
                            continue
        except Exception:
            pass

    def _populate_snapshots_list(self):
        """Populate the snapshots list UI."""
        # Clear existing
        while True:
            child = self.snapshots_list.get_first_child()
            if child is None:
                break
            self.snapshots_list.remove(child)

        # Update count
        self.snapshot_count.set_label(f'{len(self.snapshots)} snapshots')

        # Show/hide empty state
        if not self.snapshots:
            self.empty_state.set_visible(True)
            self.snapshots_list.set_visible(False)
            self.status_subtitle.set_text('Last snapshot: Never')
            return

        self.empty_state.set_visible(False)
        self.snapshots_list.set_visible(True)

        # Update status
        latest = max(self.snapshots, key=lambda s: s.date)
        self.status_subtitle.set_text(f'Last snapshot: {latest.date.strftime("%Y-%m-%d %H:%M")}')

        # Add snapshot rows
        for snapshot in sorted(self.snapshots, key=lambda s: s.date, reverse=True):
            row = self._create_snapshot_row(snapshot)
            self.snapshots_list.append(row)

    def _create_snapshot_row(self, snapshot: Snapshot) -> Gtk.Widget:
        row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        row.add_css_class('snapshot-row')

        info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
        info_box.set_hexpand(True)
        row.append(info_box)

        # Name and type badge
        name_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        info_box.append(name_box)

        name_label = Gtk.Label(label=snapshot.name)
        name_label.add_css_class('snapshot-name')
        name_label.set_halign(Gtk.Align.START)
        name_box.append(name_label)

        type_label = Gtk.Label(label=snapshot.snapshot_type.value.upper())
        type_label.add_css_class('snapshot-type')
        type_label.add_css_class(f'snapshot-type-{snapshot.snapshot_type.value}')
        name_box.append(type_label)

        # Date and size
        details_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=16)
        info_box.append(details_box)

        date_label = Gtk.Label(label=snapshot.date.strftime('%Y-%m-%d %H:%M'))
        date_label.add_css_class('snapshot-date')
        details_box.append(date_label)

        size_label = Gtk.Label(label=snapshot.size)
        size_label.add_css_class('snapshot-size')
        details_box.append(size_label)

        # Actions
        actions_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        row.append(actions_box)

        restore_btn = Gtk.Button(label='Restore')
        restore_btn.add_css_class('restore-button')
        restore_btn.connect('clicked', self._on_restore_snapshot, snapshot)
        actions_box.append(restore_btn)

        delete_btn = Gtk.Button(label='üóëÔ∏è')
        delete_btn.add_css_class('delete-button')
        delete_btn.connect('clicked', self._on_delete_snapshot, snapshot)
        actions_box.append(delete_btn)

        return row

    def _on_refresh(self, button):
        self._load_snapshots()

    def _on_create_snapshot(self, button):
        """Create a new snapshot."""
        dialog = Adw.MessageDialog(
            transient_for=self, heading='Create Snapshot', body='Enter a name for this snapshot:'
        )

        entry = Gtk.Entry()
        entry.set_placeholder_text('e.g., Before system update')
        dialog.set_extra_child(entry)

        dialog.add_response('cancel', 'Cancel')
        dialog.add_response('create', 'Create')
        dialog.set_response_appearance('create', Adw.ResponseAppearance.SUGGESTED)

        dialog.connect('response', self._on_create_response, entry)
        dialog.present()

    def _on_create_response(self, dialog, response, entry):
        if response == 'create':
            name = entry.get_text().strip() or 'Manual snapshot'
            self._do_create_snapshot(name)

    def _do_create_snapshot(self, name: str):
        """Actually create the snapshot using snapper."""
        # Show progress
        progress_dialog = Adw.MessageDialog(transient_for=self, heading='Creating Snapshot', body='Please wait...')
        progress_dialog.present()

        def create_thread():
            try:
                if self.backup_tool == 'snapper':
                    result = subprocess.run(
                        ['pkexec', 'snapper', 'create', '--description', name, '--cleanup-algorithm', 'number'],
                        capture_output=True, text=True, timeout=300
                    )
                    if result.returncode == 0:
                        GLib.idle_add(self._snapshot_created, progress_dialog)
                    else:
                        GLib.idle_add(self._snapshot_failed, progress_dialog, result.stderr or 'Unknown error')
                else:
                    GLib.idle_add(self._snapshot_failed, progress_dialog, 'Snapper not configured')
            except Exception as e:
                GLib.idle_add(self._snapshot_failed, progress_dialog, str(e))

        thread = threading.Thread(target=create_thread)
        thread.daemon = True
        thread.start()

    def _snapshot_created(self, dialog):
        dialog.close()
        self._load_snapshots()

        success_dialog = Adw.MessageDialog(
            transient_for=self, heading='Snapshot Created', body='Your system snapshot has been created successfully.'
        )
        success_dialog.add_response('ok', 'OK')
        success_dialog.present()

    def _snapshot_failed(self, dialog, error):
        dialog.close()

        error_dialog = Adw.MessageDialog(
            transient_for=self, heading='Snapshot Failed', body=f'Could not create snapshot: {error}'
        )
        error_dialog.add_response('ok', 'OK')
        error_dialog.present()

    def _on_restore_snapshot(self, button, snapshot: Snapshot):
        """Restore a snapshot."""
        dialog = Adw.MessageDialog(
            transient_for=self,
            heading='Restore Snapshot?',
            body=f"This will restore your system to the state from '{snapshot.name}' ({snapshot.date.strftime('%Y-%m-%d %H:%M')}).\n\nYour computer will need to restart. Make sure you've saved all your work.",
        )

        dialog.add_response('cancel', 'Cancel')
        dialog.add_response('restore', 'Restore')
        dialog.set_response_appearance('restore', Adw.ResponseAppearance.DESTRUCTIVE)

        dialog.connect('response', self._on_restore_response, snapshot)
        dialog.present()

    def _on_restore_response(self, dialog, response, snapshot: Snapshot):
        if response == 'restore':
            try:
                if self.backup_tool == 'snapper':
                    # Snapper rollback creates a new snapshot from the selected one
                    # This is safer than directly replacing files
                    subprocess.Popen(['pkexec', 'snapper', 'rollback', snapshot.id])

                    # Show info about reboot
                    info_dialog = Adw.MessageDialog(
                        transient_for=self,
                        heading='Rollback Initiated',
                        body='A rollback snapshot has been created. Please reboot to apply the changes.',
                    )
                    info_dialog.add_response('ok', 'OK')
                    info_dialog.present()
            except Exception:
                pass

    def _on_delete_snapshot(self, button, snapshot: Snapshot):
        """Delete a snapshot."""
        dialog = Adw.MessageDialog(
            transient_for=self,
            heading='Delete Snapshot?',
            body=f"Are you sure you want to delete '{snapshot.name}'? This action cannot be undone.",
        )

        dialog.add_response('cancel', 'Cancel')
        dialog.add_response('delete', 'Delete')
        dialog.set_response_appearance('delete', Adw.ResponseAppearance.DESTRUCTIVE)

        dialog.connect('response', self._on_delete_response, snapshot)
        dialog.present()

    def _on_delete_response(self, dialog, response, snapshot: Snapshot):
        if response == 'delete':
            try:
                if self.backup_tool == 'snapper':
                    subprocess.run(
                        ['pkexec', 'snapper', 'delete', snapshot.id],
                        capture_output=True, timeout=60
                    )
                    self._load_snapshots()
            except Exception:
                pass


class BackupApp(Adw.Application):
    def __init__(self):
        super().__init__(application_id='com.aegis.backup', flags=Gio.ApplicationFlags.FLAGS_NONE)

    def do_activate(self):
        win = BackupWindow(self)
        win.present()


def main():
    app = BackupApp()
    app.run()


if __name__ == '__main__':
    main()
