#!/usr/sbin/nft -f
# Aegis Linux - nftables Firewall Configuration
# =============================================================================
# Default deny inbound policy with sensible exceptions for desktop use
# =============================================================================

# Clear all existing rules
flush ruleset

# =============================================================================
# IPv4/IPv6 Filter Table
# =============================================================================
table inet aegis_filter {
    # -------------------------------------------------------------------------
    # Input Chain - Incoming traffic
    # -------------------------------------------------------------------------
    chain input {
        type filter hook input priority filter; policy drop;

        # Allow established and related connections
        ct state established,related accept

        # Drop invalid packets
        ct state invalid drop

        # Allow loopback interface
        iif "lo" accept

        # Allow ICMP (ping) with rate limiting
        ip protocol icmp icmp type {
            echo-request,
            destination-unreachable,
            time-exceeded,
            parameter-problem
        } limit rate 10/second accept

        # Allow ICMPv6 essential messages
        ip6 nexthdr icmpv6 icmpv6 type {
            echo-request,
            echo-reply,
            destination-unreachable,
            packet-too-big,
            time-exceeded,
            parameter-problem,
            nd-router-solicit,
            nd-router-advert,
            nd-neighbor-solicit,
            nd-neighbor-advert
        } accept

        # Allow mDNS (Avahi/Bonjour) for local network discovery
        udp dport 5353 ip daddr 224.0.0.251 accept
        udp dport 5353 ip6 daddr ff02::fb accept

        # Allow DHCP client
        udp sport 67 udp dport 68 accept
        udp sport 547 udp dport 546 accept

        # Allow Syncthing (uncomment if using)
        # tcp dport 22000 accept
        # udp dport 22000 accept
        # udp dport 21027 accept

        # Allow KDE Connect (uncomment if using)
        # tcp dport 1714-1764 accept
        # udp dport 1714-1764 accept

        # Allow SSH (uncomment if needed, consider fail2ban)
        # tcp dport 22 accept

        # Log dropped packets (uncomment for debugging)
        # log prefix "nft_drop: " flags all counter

        # Everything else is dropped by policy
    }

    # -------------------------------------------------------------------------
    # Forward Chain - Routed traffic
    # -------------------------------------------------------------------------
    chain forward {
        type filter hook forward priority filter; policy drop;

        # Allow forwarding for established connections
        ct state established,related accept

        # Drop invalid packets
        ct state invalid drop

        # Allow Docker/container forwarding (if using Docker)
        # iifname "docker*" accept
        # oifname "docker*" accept

        # Allow libvirt/VM forwarding (if using VMs)
        # iifname "virbr*" accept
        # oifname "virbr*" accept
    }

    # -------------------------------------------------------------------------
    # Output Chain - Outgoing traffic
    # -------------------------------------------------------------------------
    chain output {
        type filter hook output priority filter; policy accept;

        # Allow all outgoing traffic by default
        # Desktop systems typically need unrestricted outbound access

        # To restrict outbound (advanced), uncomment and customize:
        # policy drop;
        # ct state established,related accept
        # oif "lo" accept
        # tcp dport { 80, 443, 53 } accept
        # udp dport { 53, 123 } accept
    }
}

# =============================================================================
# Connection Tracking Helpers
# =============================================================================
# Enable helpers for protocols that need them (FTP, SIP, etc.)
# These are disabled by default for security
# table inet aegis_helpers {
#     ct helper ftp-standard {
#         type "ftp" protocol tcp;
#     }
#     chain input {
#         type filter hook input priority 10;
#         tcp dport 21 ct helper set "ftp-standard"
#     }
# }

# =============================================================================
# Port Knocking (optional advanced feature)
# =============================================================================
# Uncomment to enable port knocking for SSH
# Knock sequence: 7000, 8000, 9000, then SSH opens for 30 seconds
#
# table inet portknock {
#     set clients_ipv4 {
#         type ipv4_addr
#         flags timeout
#     }
#     set clients_ipv6 {
#         type ipv6_addr
#         flags timeout
#     }
#     set candidates_ipv4 {
#         type ipv4_addr . inet_service
#         flags timeout
#     }
#     set candidates_ipv6 {
#         type ipv6_addr . inet_service
#         flags timeout
#     }
#
#     chain input {
#         type filter hook input priority -10; policy accept;
#
#         tcp dport 22 ip saddr @clients_ipv4 accept
#         tcp dport 22 ip6 saddr @clients_ipv6 accept
#
#         tcp dport 9000 ip saddr . 8000 @candidates_ipv4 add @clients_ipv4 { ip saddr timeout 30s }
#         tcp dport 9000 ip6 saddr . 8000 @candidates_ipv6 add @clients_ipv6 { ip6 saddr timeout 30s }
#
#         tcp dport 8000 ip saddr . 7000 @candidates_ipv4 add @candidates_ipv4 { ip saddr . 8000 timeout 5s }
#         tcp dport 8000 ip6 saddr . 7000 @candidates_ipv6 add @candidates_ipv6 { ip6 saddr . 8000 timeout 5s }
#
#         tcp dport 7000 add @candidates_ipv4 { ip saddr . 7000 timeout 5s }
#         tcp dport 7000 add @candidates_ipv6 { ip6 saddr . 7000 timeout 5s }
#     }
# }
