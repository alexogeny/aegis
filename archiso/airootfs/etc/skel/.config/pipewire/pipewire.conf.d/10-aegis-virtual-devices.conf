# Aegis Linux - PipeWire Virtual Audio Devices
# Creates virtual sinks that route to headphones/speakers
# and provides monitor sources for OBS/streaming

context.modules = [
    #
    # Virtual Sinks - These capture audio from apps and play to default output
    # Each has a "monitor" source that OBS can capture
    #

    # Music/Media - Spotify, VLC, MPV, etc.
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "Music-Media"
            node.description = "Music & Media"
            audio.position = [ FL FR ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "music-media-sink"
                node.description = "Music & Media"
                node.passive = true
            }
            playback.props = {
                node.name = "music-media-output"
                node.description = "Music & Media → Headphones"
                node.passive = true
                # Routes to default output (headphones/speakers)
                stream.dont-remix = true
                node.target = "default"
            }
        }
    }

    # Voice Chat - Discord, Slack, Zoom, Teams, etc.
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "Voice-Chat"
            node.description = "Voice Chat"
            audio.position = [ FL FR ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "voice-chat-sink"
                node.description = "Voice Chat"
                node.passive = true
            }
            playback.props = {
                node.name = "voice-chat-output"
                node.description = "Voice Chat → Headphones"
                node.passive = true
                stream.dont-remix = true
                node.target = "default"
            }
        }
    }

    # Game Audio - Steam, Lutris, etc.
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "Game-Audio"
            node.description = "Game Audio"
            audio.position = [ FL FR ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "game-audio-sink"
                node.description = "Game Audio"
                node.passive = true
            }
            playback.props = {
                node.name = "game-audio-output"
                node.description = "Game Audio → Headphones"
                node.passive = true
                stream.dont-remix = true
                node.target = "default"
            }
        }
    }

    # System Sounds - Notifications, alerts
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "System-Sounds"
            node.description = "System Sounds"
            audio.position = [ FL FR ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "system-sounds-sink"
                node.description = "System Sounds"
                node.passive = true
            }
            playback.props = {
                node.name = "system-sounds-output"
                node.description = "System Sounds → Headphones"
                node.passive = true
                stream.dont-remix = true
                node.target = "default"
            }
        }
    }

    # Browser Audio - Firefox, Chrome (for non-voice/media)
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "Browser-Audio"
            node.description = "Browser Audio"
            audio.position = [ FL FR ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "browser-audio-sink"
                node.description = "Browser Audio"
                node.passive = true
            }
            playback.props = {
                node.name = "browser-audio-output"
                node.description = "Browser Audio → Headphones"
                node.passive = true
                stream.dont-remix = true
                node.target = "default"
            }
        }
    }

    #
    # Stream Output - A sink for audio you want in your stream
    # OBS captures from this source
    #
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "Stream-Output"
            node.description = "Stream Output (OBS Capture)"
            audio.position = [ FL FR ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "stream-output-sink"
                node.description = "Stream Output"
                node.passive = true
            }
            playback.props = {
                media.class = Audio/Source
                node.name = "stream-output-source"
                node.description = "Stream Output (OBS Capture)"
                node.passive = true
            }
        }
    }

    #
    # Microphone Processing Chain
    #
    {
        name = libpipewire-module-loopback
        args = {
            node.name = "Mic-Processed"
            node.description = "Microphone (Processed)"
            audio.position = [ MONO ]
            capture.props = {
                media.class = Audio/Sink
                node.name = "mic-processed-input"
                node.description = "Mic DSP Input"
                node.passive = true
            }
            playback.props = {
                media.class = Audio/Source
                node.name = "mic-processed-source"
                node.description = "Microphone (Processed)"
                node.passive = true
            }
        }
    }
]

# Combined sink that mixes everything for stream
# Uses null-sink to create a combined capture point
context.objects = [
    {
        factory = adapter
        args = {
            factory.name = support.null-audio-sink
            node.name = "stream-mix-sink"
            node.description = "Stream Mix (All Desktop Audio)"
            media.class = Audio/Sink/Virtual
            audio.position = [ FL FR ]
            monitor.channel-volumes = true
            monitor.passthrough = true
            object.linger = true
        }
    }
]
