# Aegis Linux - Performance Tuning Configuration
# =============================================================================
# Optimizations for modern desktop systems with SSD storage
# =============================================================================

# -----------------------------------------------------------------------------
# Virtual Memory
# -----------------------------------------------------------------------------
# Reduce swappiness for SSD systems (default is 60)
# Lower value = prefer to keep data in RAM
vm.swappiness = 10

# How much dirty data can exist before processes start writing
# Higher values improve performance but risk data loss on crash
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# Time before dirty data is written (centiseconds)
vm.dirty_expire_centisecs = 3000
vm.dirty_writeback_centisecs = 500

# VFS cache pressure (default 100)
# Lower = keep dentries/inodes cached longer
vm.vfs_cache_pressure = 50

# Overcommit memory settings
# 0 = Heuristic overcommit (default)
# 1 = Always overcommit (unsafe)
# 2 = Don't overcommit
vm.overcommit_memory = 0
vm.overcommit_ratio = 50

# Zone reclaim mode (for NUMA systems)
vm.zone_reclaim_mode = 0

# Page cluster (for swap, SSDs don't benefit from prefetching)
vm.page-cluster = 0

# Watermark boost factor (helps prevent OOM situations)
vm.watermark_boost_factor = 0
vm.watermark_scale_factor = 125

# Compact memory proactively (reduces fragmentation)
vm.compaction_proactiveness = 20

# -----------------------------------------------------------------------------
# I/O Scheduling
# -----------------------------------------------------------------------------
# Maximum read-ahead for block devices (KB)
# SSDs don't benefit as much from large read-ahead
# This is a default; udev rules set per-device values
# (No direct sysctl for this, handled via udev)

# -----------------------------------------------------------------------------
# Kernel Scheduling
# -----------------------------------------------------------------------------
# Scheduler tuning for desktop responsiveness
# Minimum granularity for CPU-bound tasks (nanoseconds)
kernel.sched_min_granularity_ns = 1000000

# Wakeup granularity (nanoseconds)
kernel.sched_wakeup_granularity_ns = 500000

# Migration cost (nanoseconds)
# Higher value = less process migration between CPUs
kernel.sched_migration_cost_ns = 500000

# Child runs first after fork (helps with fork-heavy workloads)
kernel.sched_child_runs_first = 0

# Autogroup for desktop responsiveness
# Groups processes by session, improves interactivity
kernel.sched_autogroup_enabled = 1

# -----------------------------------------------------------------------------
# File System
# -----------------------------------------------------------------------------
# Increase inotify limits for IDEs and file managers
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 1024
fs.inotify.max_queued_events = 32768

# Increase file handle limits
fs.file-max = 2097152
fs.nr_open = 1048576

# Increase AIO limits (for database-like workloads)
fs.aio-max-nr = 1048576

# Dentry cache hash table size (let kernel auto-tune)
# fs.dentry-state is read-only, kernel manages this

# -----------------------------------------------------------------------------
# Network Performance
# -----------------------------------------------------------------------------
# Increase socket buffer sizes
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# TCP buffer tuning
net.ipv4.tcp_rmem = 4096 131072 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Increase netdev budget for better throughput
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 8000

# Increase backlog
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 8192

# TCP optimization
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_no_metrics_save = 1

# BBR congestion control (if available)
# net.ipv4.tcp_congestion_control = bbr
# net.core.default_qdisc = fq

# -----------------------------------------------------------------------------
# Kernel Limits
# -----------------------------------------------------------------------------
# PID max (allows more processes)
kernel.pid_max = 4194304

# Threads max
kernel.threads-max = 4194304

# Keys quota
kernel.keys.maxkeys = 10000
kernel.keys.maxbytes = 2500000

# -----------------------------------------------------------------------------
# Shared Memory (for apps like Chrome, databases)
# -----------------------------------------------------------------------------
# Maximum shared memory segment size (bytes)
# Half of RAM is reasonable for most systems
kernel.shmmax = 4294967296
kernel.shmall = 2097152
