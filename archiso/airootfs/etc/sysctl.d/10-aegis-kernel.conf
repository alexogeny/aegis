# Aegis Linux - Kernel Hardening Configuration
# =============================================================================
# These settings enhance system security by restricting access to sensitive
# kernel information and disabling dangerous features.
# =============================================================================

# -----------------------------------------------------------------------------
# Kernel Pointer Restrictions
# -----------------------------------------------------------------------------
# Hide kernel pointers from non-privileged users
# 0 = No restrictions
# 1 = Hide from users without CAP_SYSLOG
# 2 = Hide from all users (recommended)
kernel.kptr_restrict = 2

# Restrict access to dmesg
# 0 = No restrictions
# 1 = Restrict to users with CAP_SYSLOG
kernel.dmesg_restrict = 1

# -----------------------------------------------------------------------------
# Disable Dangerous Features
# -----------------------------------------------------------------------------
# Disable kexec (prevents loading new kernel at runtime)
# This prevents attackers from loading a malicious kernel
kernel.kexec_load_disabled = 1

# Disable SysRq key combinations
# SysRq can be used to perform dangerous operations
# 0 = Disabled, 1 = All enabled
kernel.sysrq = 0

# Disable unprivileged BPF
# BPF can be exploited for kernel attacks
kernel.unprivileged_bpf_disabled = 1

# Harden BPF JIT compiler
# 0 = No hardening
# 1 = Hardening for unprivileged users
# 2 = Hardening for all users (recommended)
net.core.bpf_jit_harden = 2

# -----------------------------------------------------------------------------
# Address Space Layout Randomization (ASLR)
# -----------------------------------------------------------------------------
# Maximize ASLR effectiveness
# 0 = Disabled
# 1 = Conservative (stack, VDSO, shared libraries)
# 2 = Full randomization (recommended)
kernel.randomize_va_space = 2

# Minimum virtual address that a process can mmap
# Higher values make NULL pointer exploits harder
vm.mmap_min_addr = 65536

# Increase mmap randomization
vm.mmap_rnd_bits = 32
vm.mmap_rnd_compat_bits = 16

# -----------------------------------------------------------------------------
# Process Security
# -----------------------------------------------------------------------------
# Restrict ptrace scope
# 0 = No restrictions (classic)
# 1 = Restricted to parent process
# 2 = Admin-only (recommended for servers)
# 3 = No ptrace allowed
kernel.yama.ptrace_scope = 2

# Disable core dumps for setuid programs
fs.suid_dumpable = 0

# Disable core dumps entirely (send to /bin/false)
kernel.core_pattern = |/bin/false

# Restrict user namespaces
# Note: Setting to 0 may break some containers and Flatpak
# Uncomment if not using containers
# kernel.unprivileged_userns_clone = 0

# -----------------------------------------------------------------------------
# File System Security
# -----------------------------------------------------------------------------
# Protect hardlinks and symlinks
# Prevents symlink/hardlink attacks in world-writable directories
fs.protected_hardlinks = 1
fs.protected_symlinks = 1

# Protect FIFOs and regular files
fs.protected_fifos = 2
fs.protected_regular = 2

# -----------------------------------------------------------------------------
# Performance Monitor Restrictions
# -----------------------------------------------------------------------------
# Restrict perf_event access
# -1 = Allow no access
# 0 = Allow access to users with CAP_PERFMON
# 1 = Allow access to users with CAP_SYS_ADMIN
# 2 = Allow all users
kernel.perf_event_paranoid = 3

# -----------------------------------------------------------------------------
# Panic Behavior (Security-focused)
# -----------------------------------------------------------------------------
# Auto-reboot after kernel panic (60 seconds)
# Ensures system doesn't stay in compromised state
kernel.panic = 60

# Panic on kernel oops (treat all oops as fatal)
# Prevents potential exploitation after kernel corruption
kernel.panic_on_oops = 1

# -----------------------------------------------------------------------------
# Memory Management
# -----------------------------------------------------------------------------
# Reduce swap pressure for better responsiveness
# Higher values = more swap usage; 10 = prefer RAM
vm.swappiness = 10

# -----------------------------------------------------------------------------
# TTY Security
# -----------------------------------------------------------------------------
# Disable automatic loading of TTY line disciplines
# Prevents loading of potentially vulnerable drivers
dev.tty.ldisc_autoload = 0

# -----------------------------------------------------------------------------
# Magic SysRq Safety (if we ever need to enable it)
# -----------------------------------------------------------------------------
# If you need SysRq for debugging, use a safe bitmask:
# 176 = sync + remount ro + reboot (safe subset)
# kernel.sysrq = 176
