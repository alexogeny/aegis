name: Build Aegis Linux ISO

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        required: false
        default: 'false'
        type: boolean
      release_tag:
        description: 'Release tag (e.g., v2026.01.18)'
        required: false
        type: string

  # Automatic build on tags
  push:
    tags:
      - 'v*.*.*'

  # Optional: build on schedule (weekly)
  # schedule:
  #   - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

env:
  ISO_NAME: aegis

jobs:
  build:
    name: Build ISO
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache pacman packages
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg/
          key: pacman-${{ hashFiles('archiso/packages.x86_64') }}
          restore-keys: |
            pacman-

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update package database and install dependencies
        run: |
          pacman -Sy --noconfirm
          pacman -S --noconfirm --needed archiso git base-devel

      - name: Setup Chaotic-AUR repository
        run: |
          # Import and sign the key
          pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key 3056513887B78AEB

          # Install chaotic-keyring and mirrorlist
          pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst"
          pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"

          # Add chaotic-aur to pacman.conf
          echo "" >> /etc/pacman.conf
          echo "[chaotic-aur]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf

      - name: Setup ArchZFS repository
        run: |
          # Import archzfs key
          pacman-key --recv-keys DDF7DB817396A49B2A2723F7403BD972F75D9D76 --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key DDF7DB817396A49B2A2723F7403BD972F75D9D76

          # Add archzfs mirrorlist
          cat > /etc/pacman.d/archzfs-mirrorlist << 'EOF'
          Server = https://archzfs.com/$repo/$arch
          Server = https://mirror.sum7.eu/archlinux/archzfs/$repo/$arch
          Server = https://mirror.biocrafting.net/archlinux/archzfs/$repo/$arch
          EOF

          # Add archzfs to pacman.conf
          echo "" >> /etc/pacman.conf
          echo "[archzfs]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/archzfs-mirrorlist" >> /etc/pacman.conf

          # Refresh package databases
          pacman -Sy

      - name: Setup EndeavourOS repository (for pre-built Calamares)
        run: |
          # Import EndeavourOS key and install keyring
          curl -fsSL "https://mirror.alpix.eu/endeavouros/repo/endeavouros/x86_64/endeavouros-keyring-20231222-1-any.pkg.tar.zst" -o /tmp/eos-keyring.pkg.tar.zst
          pacman -U --noconfirm --config <(echo -e "[options]\nSigLevel = Never") /tmp/eos-keyring.pkg.tar.zst
          pacman-key --populate endeavouros

          # Install mirrorlist
          pacman -U --noconfirm "https://mirror.alpix.eu/endeavouros/repo/endeavouros/x86_64/endeavouros-mirrorlist-26-1-any.pkg.tar.zst"

          # Add endeavouros to pacman.conf
          echo "" >> /etc/pacman.conf
          echo "[endeavouros]" >> /etc/pacman.conf
          echo "SigLevel = PackageRequired" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/endeavouros-mirrorlist" >> /etc/pacman.conf

          # Refresh package databases
          pacman -Sy

      - name: Prepare ISO profile
        run: |
          # Create a working copy of the archiso profile
          cp -r archiso /tmp/aegis-profile

          # Add calamares from EndeavourOS repo
          echo "calamares" >> /tmp/aegis-profile/packages.x86_64

          # Move custom calamares configs temporarily (conflicts with package defaults)
          if [ -d "/tmp/aegis-profile/airootfs/etc/calamares" ]; then
              mv /tmp/aegis-profile/airootfs/etc/calamares /tmp/aegis-calamares-custom
              rm -f /tmp/aegis-profile/airootfs/usr/share/applications/calamares.desktop 2>/dev/null || true
          fi

      - name: Check available disk space
        run: |
          df -h
          echo "---"
          du -sh /var/cache/pacman/pkg/ 2>/dev/null || true

      - name: Build ISO
        run: |
          # Use workspace directory which has more space than /tmp in containers
          mkdir -p $GITHUB_WORKSPACE/aegis-work $GITHUB_WORKSPACE/aegis-out
          mkarchiso -v -w $GITHUB_WORKSPACE/aegis-work -o $GITHUB_WORKSPACE/aegis-out /tmp/aegis-profile

      - name: Apply custom Calamares configs
        run: |
          # Restore custom calamares configs over package defaults
          if [ -d "/tmp/aegis-calamares-custom" ]; then
              cp -rf /tmp/aegis-calamares-custom/* $GITHUB_WORKSPACE/aegis-work/x86_64/airootfs/etc/calamares/

              # Remove old squashfs and ISO to free space before rebuilding
              rm -f $GITHUB_WORKSPACE/aegis-work/x86_64/airootfs.sfs
              rm -f $GITHUB_WORKSPACE/aegis-out/*.iso

              # Rebuild squashfs with custom configs
              cd $GITHUB_WORKSPACE/aegis-work/x86_64
              mksquashfs airootfs airootfs.sfs -comp zstd -Xcompression-level 12 -b 1M

              # Copy to iso directory
              cp airootfs.sfs iso/aegis/x86_64/

              # Rebuild ISO
              xorriso -as mkisofs \
                  -iso-level 3 -full-iso9660-filenames -joliet -joliet-long -rational-rock \
                  -volid "AEGIS_$(date +%Y%m)" \
                  -appid "Aegis Linux Live/Installer" \
                  -publisher "Aegis Linux <https://github.com/aegis-linux>" \
                  -preparer "mkarchiso" \
                  -eltorito-boot syslinux/isolinux.bin \
                  -eltorito-catalog syslinux/boot.cat \
                  -no-emul-boot -boot-load-size 4 -boot-info-table \
                  -isohybrid-mbr /usr/lib/syslinux/bios/isohdpfx.bin \
                  -eltorito-alt-boot \
                  -e EFI/efiboot.img \
                  -no-emul-boot -isohybrid-gpt-basdat \
                  -output $GITHUB_WORKSPACE/aegis-out/aegis-linux.iso \
                  iso/
          fi

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE/aegis-out
          for iso in *.iso; do
            sha256sum "$iso" > "${iso}.sha256"
            b2sum "$iso" > "${iso}.b2sum"
          done
          ls -lh
          # Copy to out directory for release upload
          mkdir -p $GITHUB_WORKSPACE/out
          cp *.iso *.sha256 *.b2sum $GITHUB_WORKSPACE/out/

      # Note: Skipping artifact upload - ISOs are too large for free tier (500MB limit)
      # The ISO will be uploaded directly to GitHub Releases instead

      - name: Get ISO filename
        id: iso_info
        run: |
          ISO_FILE=$(ls out/*.iso | head -1)
          ISO_NAME=$(basename "$ISO_FILE")
          ISO_SIZE=$(du -h "$ISO_FILE" | cut -f1)
          echo "iso_file=$ISO_FILE" >> $GITHUB_OUTPUT
          echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.create_release == true)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || inputs.release_tag || format('v{0}', github.run_id) }}
          name: Aegis Linux ${{ github.ref_name || inputs.release_tag || format('Build {0}', github.run_id) }}
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          generate_release_notes: true
          body: |
            ## Aegis Linux ISO Release

            **ISO:** `${{ steps.iso_info.outputs.iso_name }}`
            **Size:** ${{ steps.iso_info.outputs.iso_size }}

            ### Features
            - Security-focused Arch Linux with AppArmor and kernel hardening
            - Hyprland Wayland compositor with Catppuccin Mocha theme
            - Developer tools: Rust, Python, Go, Docker, K8s
            - Content creator ready: OBS, EasyEffects, Elgato support

            ### Verification
            ```bash
            # SHA256
            sha256sum -c ${{ steps.iso_info.outputs.iso_name }}.sha256

            # BLAKE2
            b2sum -c ${{ steps.iso_info.outputs.iso_name }}.b2sum
            ```

            ### Installation
            1. Write to USB: `sudo dd if=${{ steps.iso_info.outputs.iso_name }} of=/dev/sdX bs=4M status=progress`
            2. Boot from USB and follow the Calamares installer

            Built with GitHub Actions on ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
          files: |
            out/*.iso
            out/*.sha256
            out/*.b2sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
