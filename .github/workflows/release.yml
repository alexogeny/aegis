name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-iso:
    name: Build ISO
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update system and install base tools
        run: pacman -Syu --noconfirm archiso git

      - name: Set up Chaotic-AUR repository
        run: |
          pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key 3056513887B78AEB
          pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst"
          pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"
          echo "" >> /etc/pacman.conf
          echo "[chaotic-aur]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf

      - name: Set up EndeavourOS repository (for calamares)
        run: |
          # Import EndeavourOS key and install keyring
          curl -fsSL "https://mirror.alpix.eu/endeavouros/repo/endeavouros/x86_64/endeavouros-keyring-20231222-1-any.pkg.tar.zst" -o /tmp/eos-keyring.pkg.tar.zst
          pacman -U --noconfirm --config <(echo -e "[options]\nSigLevel = Never") /tmp/eos-keyring.pkg.tar.zst
          pacman-key --populate endeavouros
          pacman -U --noconfirm "https://mirror.alpix.eu/endeavouros/repo/endeavouros/x86_64/endeavouros-mirrorlist-26-1-any.pkg.tar.zst"
          echo "" >> /etc/pacman.conf
          echo "[endeavouros]" >> /etc/pacman.conf
          echo "SigLevel = PackageRequired" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/endeavouros-mirrorlist" >> /etc/pacman.conf

      - name: Set up ArchZFS repository
        run: |
          pacman-key --recv-keys DDF7DB817396A49B2A2723F7403BD972F75D9D76 --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key DDF7DB817396A49B2A2723F7403BD972F75D9D76
          cat > /etc/pacman.d/archzfs-mirrorlist << 'EOF'
          Server = https://archzfs.com/$repo/$arch
          Server = https://mirror.sum7.eu/archlinux/archzfs/$repo/$arch
          Server = https://mirror.biocrafting.net/archlinux/archzfs/$repo/$arch
          EOF
          echo "" >> /etc/pacman.conf
          echo "[archzfs]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/archzfs-mirrorlist" >> /etc/pacman.conf
          pacman -Sy

      - name: Prepare profile
        run: |
          cp -r archiso /tmp/aegis-profile
          # Add calamares from EndeavourOS repo
          echo "calamares" >> /tmp/aegis-profile/packages.x86_64
          # Move custom calamares configs temporarily (conflicts with package)
          mv /tmp/aegis-profile/airootfs/etc/calamares /tmp/aegis-calamares-custom
          rm -f /tmp/aegis-profile/airootfs/usr/share/applications/calamares.desktop
          # Sync pacman database with all repos
          pacman -Sy

      - name: Build ISO
        run: |
          mkdir -p /tmp/aegis-work out
          mkarchiso -v -w /tmp/aegis-work -o out /tmp/aegis-profile
          # Restore our custom calamares configs over package defaults
          cp -rf /tmp/aegis-calamares-custom/* /tmp/aegis-work/x86_64/airootfs/etc/calamares/

      - name: Rebuild squashfs and ISO with custom configs
        run: |
          cd /tmp/aegis-work/x86_64
          # Rebuild squashfs
          rm -f airootfs.sfs
          mksquashfs airootfs airootfs.sfs -comp zstd -Xcompression-level 15 -b 1M
          # Copy to iso directory
          cp airootfs.sfs iso/aegis/x86_64/
          # Rebuild ISO using the same method as mkarchiso
          rm -f $GITHUB_WORKSPACE/out/aegis-*.iso
          xorriso -as mkisofs \
            -iso-level 3 -full-iso9660-filenames -joliet -joliet-long -rational-rock \
            -volid "AEGIS_$(date +%Y%m)" \
            -appid "Aegis Linux Live/Installer" \
            -publisher "Aegis Linux <https://github.com/aegis-linux>" \
            -preparer "mkarchiso" \
            -eltorito-boot syslinux/isolinux.bin \
            -eltorito-catalog syslinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -isohybrid-mbr /usr/lib/syslinux/bios/isohdpfx.bin \
            -eltorito-alt-boot \
            -e EFI/efiboot.img \
            -no-emul-boot -isohybrid-gpt-basdat \
            -output $GITHUB_WORKSPACE/out/aegis-linux.iso \
            iso/

      - name: Generate checksums
        run: |
          cd out
          sha256sum "aegis-linux.iso" > "aegis-linux.iso.sha256"
          b2sum "aegis-linux.iso" > "aegis-linux.iso.b2sum"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-iso
          path: out/*
          retention-days: 7

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/*.iso
            out/*.sha256
            out/*.b2sum
          generate_release_notes: true
