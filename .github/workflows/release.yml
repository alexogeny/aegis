name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-iso:
    name: Build ISO
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Update system and install base tools
        run: pacman -Syu --noconfirm archiso git base-devel

      - name: Set up Chaotic-AUR repository
        run: |
          pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key 3056513887B78AEB
          pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst"
          pacman -U --noconfirm "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"
          echo "" >> /etc/pacman.conf
          echo "[chaotic-aur]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf

      - name: Set up ArchZFS repository
        run: |
          pacman-key --recv-keys DDF7DB817396A49B2A2723F7403BD972F75D9D76 --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key DDF7DB817396A49B2A2723F7403BD972F75D9D76
          cat > /etc/pacman.d/archzfs-mirrorlist << 'EOF'
          Server = https://archzfs.com/$repo/$arch
          Server = https://mirror.sum7.eu/archlinux/archzfs/$repo/$arch
          Server = https://mirror.biocrafting.net/archlinux/archzfs/$repo/$arch
          EOF
          echo "" >> /etc/pacman.conf
          echo "[archzfs]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/archzfs-mirrorlist" >> /etc/pacman.conf
          pacman -Sy

      - name: Build Calamares from AUR
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          pacman -S --noconfirm --needed cmake extra-cmake-modules qt6-base qt6-declarative qt6-tools \
              qt6-translations kpmcore yaml-cpp boost libpwquality icu polkit-qt6 \
              kconfig kcoreaddons ki18n kiconthemes kio kparts kservice kwidgetsaddons \
              python squashfs-tools appstream-qt plasma5support
          cd /tmp
          sudo -u builder git clone https://aur.archlinux.org/calamares.git
          cd calamares
          sudo -u builder makepkg -s --noconfirm || echo "Calamares build failed, will use archinstall"
          if ls *.pkg.tar.zst 1>/dev/null 2>&1; then
              pacman -U --noconfirm *.pkg.tar.zst
              mkdir -p /tmp/localrepo
              cp *.pkg.tar.zst /tmp/localrepo/
              cd /tmp/localrepo
              repo-add localrepo.db.tar.gz *.pkg.tar.zst
              echo "CALAMARES_BUILT=true" >> $GITHUB_ENV
          fi

      - name: Prepare profile
        run: |
          cp -r archiso /tmp/aegis-profile
          if [ "$CALAMARES_BUILT" = "true" ]; then
              echo "" >> /tmp/aegis-profile/pacman.conf
              echo "[localrepo]" >> /tmp/aegis-profile/pacman.conf
              echo "SigLevel = Optional TrustAll" >> /tmp/aegis-profile/pacman.conf
              echo "Server = file:///tmp/localrepo" >> /tmp/aegis-profile/pacman.conf
              echo "calamares" >> /tmp/aegis-profile/packages.x86_64
              # Remove custom .desktop to avoid conflict with package
              rm -f /tmp/aegis-profile/airootfs/usr/share/applications/calamares.desktop
          fi

      - name: Build ISO
        run: |
          mkdir -p /tmp/aegis-work out
          mkarchiso -v -w /tmp/aegis-work -o out /tmp/aegis-profile

      - name: Rename and generate checksums
        run: |
          cd out
          # Rename to consistent filename for easy download links
          for iso in aegis-*.iso; do
              mv "$iso" "aegis-linux.iso"
              break
          done
          sha256sum "aegis-linux.iso" > "aegis-linux.iso.sha256"
          b2sum "aegis-linux.iso" > "aegis-linux.iso.b2sum"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-iso
          path: out/*
          retention-days: 7

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/*.iso
            out/*.sha256
            out/*.b2sum
          generate_release_notes: true
